<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ Test Backup/Restore Interactif</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .description {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-number {
      background: #667eea;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    button:hover {
      transform: scale(1.02);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: scale(1);
    }

    button.secondary {
      background: #f0f0f0;
      color: #667eea;
      border: 2px solid #667eea;
    }

    button.secondary:hover {
      background: #e8e8e8;
    }

    .info-box {
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.95em;
      line-height: 1.6;
    }

    .success {
      color: #10b981;
    }

    .error {
      color: #ef4444;
    }

    .warning {
      color: #f59e0b;
    }

    .checksum-display {
      font-family: 'Courier New', monospace;
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      word-break: break-all;
      font-size: 0.9em;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    .log-box {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .log-entry {
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .log-success {
      color: #10b981;
    }

    .log-error {
      color: #ef4444;
    }

    .log-info {
      color: #3b82f6;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-success { background: #10b981; }
    .status-error { background: #ef4444; }
    .status-pending { background: #f59e0b; animation: pulse 1.5s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .summary {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .summary h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .checklist {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      font-size: 1.05em;
      padding: 10px;
      background: #f9fafb;
      border-radius: 6px;
    }

    .checklist-item.done {
      color: #10b981;
    }

    .checklist-item.pending {
      color: #f59e0b;
    }

    .checklist-item.error {
      color: #ef4444;
    }

    .checklist-icon {
      margin-right: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß™ Test Backup/Restore Interactif</h1>
      <p class="description">T√¢che 1.3 - Phase 1 Finale</p>
    </header>

    <div class="grid">
      <!-- √âTAPE 1 -->
      <div class="card">
        <h2><span class="step-number">1</span>Pr√©paration</h2>
        <div class="content">
          <div class="info-box">
            Cette √©tape pr√©pare les services et les donn√©es de test. L'app doit √™tre charg√©e et les services doivent √™tre disponibles.
          </div>
          <button onclick="step1()">D√©marrer Test</button>
          <div id="step1-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 2 -->
      <div class="card">
        <h2><span class="step-number">2</span>Cr√©er Factures</h2>
        <div class="content">
          <div class="info-box">
            Cr√©e 3 factures de test: 1500‚Ç¨, 2500‚Ç¨, 3000‚Ç¨. Ces factures seront sauvegard√©es dans le backup.
          </div>
          <button onclick="step2()">Cr√©er 3 Factures</button>
          <div id="step2-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 3 -->
      <div class="card">
        <h2><span class="step-number">3</span>Cr√©er Backup</h2>
        <div class="content">
          <div class="info-box">
            Cr√©e un backup complet avec checksum SHA-256. Ce checksum sera utilis√© pour valider l'int√©grit√© apr√®s restauration.
          </div>
          <button onclick="step3()">Cr√©er Backup</button>
          <div id="step3-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 4 -->
      <div class="card">
        <h2><span class="step-number">4</span>V√©rifier Checksum</h2>
        <div class="content">
          <div class="info-box">
            Valide que le checksum SHA-256 est au bon format (64 caract√®res hexad√©cimaux) et correspond aux m√©tadonn√©es.
          </div>
          <button onclick="step4()">Valider Checksum</button>
          <div id="step4-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 5 -->
      <div class="card">
        <h2><span class="step-number">5</span>Exporter Backup</h2>
        <div class="content">
          <div class="info-box">
            Exporte le backup en fichier JSON compress√©. Ce fichier sera t√©l√©charg√© et utilis√© pour l'√©tape de restauration.
          </div>
          <button onclick="step5()">T√©l√©charger Backup</button>
          <div id="step5-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 6 -->
      <div class="card">
        <h2><span class="step-number">6</span>Simuler Corruption</h2>
        <div class="content">
          <div class="info-box">
            Modifie directement le total d'une facture (1500‚Ç¨ ‚Üí 5000‚Ç¨) sans mettre √† jour le hash int√©grit√©. Cela simule une corruption de donn√©es.
          </div>
          <button onclick="step6()">Corrompre Donn√©es</button>
          <div id="step6-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 7 -->
      <div class="card">
        <h2><span class="step-number">7</span>Backup Corrompu</h2>
        <div class="content">
          <div class="info-box">
            Cr√©e un second backup qui capture l'√©tat corrompu des donn√©es. On peut voir que le checksum est diff√©rent du premier.
          </div>
          <button onclick="step7()">Cr√©er Backup Corrompu</button>
          <div id="step7-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 8 -->
      <div class="card">
        <h2><span class="step-number">8</span>Restaurer Backup</h2>
        <div class="content">
          <div class="info-box">
            Restaure depuis le backup original (non corrompu). Les donn√©es corrompues seront √©cras√©es par les donn√©es sauvegard√©es.
          </div>
          <button onclick="step8()">Restaurer Backup</button>
          <div id="step8-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 9 -->
      <div class="card">
        <h2><span class="step-number">9</span>Valider Int√©grit√©</h2>
        <div class="content">
          <div class="info-box">
            V√©rifie que la facture corrompue (5000‚Ç¨) a bien √©t√© restaur√©e √† sa valeur originale (1500‚Ç¨). C'est la preuve que le restauration fonctionne!
          </div>
          <button onclick="step9()">V√©rifier Int√©grit√©</button>
          <div id="step9-output" class="log-box" style="display:none;"></div>
        </div>
      </div>

      <!-- √âTAPE 10 -->
      <div class="card">
        <h2><span class="step-number">10</span>V√©rifier Audit Logs</h2>
        <div class="content">
          <div class="info-box">
            Cherche les logs d'audit relatifs aux op√©rations de backup/restore. Ces logs doivent documenter toutes les actions.
          </div>
          <button onclick="step10()">V√©rifier Logs</button>
          <div id="step10-output" class="log-box" style="display:none;"></div>
        </div>
      </card>
    </div>

    <!-- R√âSUM√â -->
    <div class="summary">
      <h2>üìä R√©sum√© du Test</h2>
      
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-value" id="progress-percent">0%</div>
          <div class="stat-label">Compl√©tude</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="tests-done">0</div>
          <div class="stat-label">√âtapes Faites</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="tests-total">10</div>
          <div class="stat-label">√âtapes Totales</div>
        </div>
      </div>

      <h3 style="margin-top: 30px; margin-bottom: 20px; color: #667eea;">Checklist de Validation</h3>
      <div class="checklist">
        <div class="checklist-item pending" id="check-1"><span class="checklist-icon">‚òê</span>Services import√©s</div>
        <div class="checklist-item pending" id="check-2"><span class="checklist-icon">‚òê</span>Factures cr√©√©es</div>
        <div class="checklist-item pending" id="check-3"><span class="checklist-icon">‚òê</span>Backup cr√©√©</div>
        <div class="checklist-item pending" id="check-4"><span class="checklist-icon">‚òê</span>Checksum valid√©</div>
        <div class="checklist-item pending" id="check-5"><span class="checklist-icon">‚òê</span>Fichier export√©</div>
        <div class="checklist-item pending" id="check-6"><span class="checklist-icon">‚òê</span>Corruption simul√©e</div>
        <div class="checklist-item pending" id="check-7"><span class="checklist-icon">‚òê</span>Backup corrompu cr√©√©</div>
        <div class="checklist-item pending" id="check-8"><span class="checklist-icon">‚òê</span>Restauration effectu√©e</div>
        <div class="checklist-item pending" id="check-9"><span class="checklist-icon">‚òê</span>Int√©grit√© valid√©e</div>
        <div class="checklist-item pending" id="check-10"><span class="checklist-icon">‚òê</span>Audit logs v√©rifi√©s</div>
      </div>

      <div id="final-result" style="margin-top: 30px; display:none;">
        <h3 style="color: #10b981; font-size: 1.5em;">üéâ TEST COMPLET!</h3>
        <p style="font-size: 1.1em; color: #666; margin-top: 10px;">
          Toutes les √©tapes ont √©t√© valid√©es. <strong>T√¢che 1.3 est TERMIN√âE!</strong>
        </p>
      </div>
    </div>
  </div>

  <script>
    // √âtat global
    const state = {
      services: null,
      testInvoices: [],
      backup: null,
      backupChecksum: null,
      corruptedBackup: null,
      completedSteps: 0
    };

    const stepElements = {};
    for (let i = 1; i <= 10; i++) {
      stepElements[`step${i}`] = document.getElementById(`step${i}-output`);
    }

    function log(stepNum, message, type = 'info') {
      const output = stepElements[`step${stepNum}`];
      const time = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      const entry = `<div class="log-entry ${className}">[${time}] ${message}</div>`;
      
      output.innerHTML += entry;
      output.scrollTop = output.scrollHeight;
    }

    function showOutput(stepNum) {
      stepElements[`step${stepNum}`].style.display = 'block';
    }

    function updateProgress() {
      const percent = Math.round((state.completedSteps / 10) * 100);
      document.getElementById('progress-percent').textContent = percent + '%';
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('tests-done').textContent = state.completedSteps;
      
      if (state.completedSteps === 10) {
        document.getElementById('final-result').style.display = 'block';
      }
    }

    function markCheckItem(num) {
      const item = document.getElementById(`check-${num}`);
      item.classList.remove('pending');
      item.classList.add('done');
      const originalText = item.textContent.substring(1);
      item.innerHTML = '';
      const iconSpan = document.createElement('span');
      iconSpan.className = 'checklist-icon status-success';
      iconSpan.style.display = 'inline-block';
      iconSpan.style.width = '20px';
      iconSpan.style.height = '20px';
      iconSpan.textContent = '‚úÖ';
      item.appendChild(iconSpan);
      item.appendChild(document.createTextNode(originalText));
      state.completedSteps++;
      updateProgress();
    }

    async function step1() {
      showOutput(1);
      log(1, 'V√©rification des services...', 'info');
      
      try {
        if (typeof window.db === 'undefined') {
          throw new Error('DB non disponible. L\'app doit √™tre charg√©e.');
        }
        
        state.services = { db: window.db };
        log(1, 'Services disponibles: ‚úÖ', 'success');
        markCheckItem(1);
      } catch (error) {
        log(1, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step2() {
      if (!state.services) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 1');
        return;
      }
      
      showOutput(2);
      log(2, 'Cr√©ation de 3 factures de test...', 'info');
      
      try {
        state.testInvoices = [
          {
            id: 'test-inv-001',
            number: 'FAC-2026-001',
            total: 1500.00,
            status: 'paid',
            type: 'invoice',
          },
          {
            id: 'test-inv-002',
            number: 'FAC-2026-002',
            total: 2500.00,
            status: 'draft',
            type: 'invoice',
          },
          {
            id: 'test-inv-003',
            number: 'FAC-2026-003',
            total: 3000.00,
            status: 'sent',
            type: 'invoice',
          }
        ];
        
        for (const inv of state.testInvoices) {
          await state.services.db.invoices.add(inv);
        }
        
        log(2, `3 factures cr√©√©es: 1500‚Ç¨, 2500‚Ç¨, 3000‚Ç¨ ‚úÖ`, 'success');
        markCheckItem(2);
      } catch (error) {
        log(2, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step3() {
      if (state.testInvoices.length === 0) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 2');
        return;
      }
      
      showOutput(3);
      log(3, 'Cr√©ation du backup...', 'info');
      
      try {
        // Note: improvedBackupService doit √™tre disponible globalement
        if (!window.improvedBackupService) {
          throw new Error('improvedBackupService non disponible');
        }
        
        state.backup = await window.improvedBackupService.createBackup();
        state.backupChecksum = state.backup.metadata.checksumSHA256;
        
        log(3, `Backup cr√©√© ‚úÖ`, 'success');
        log(3, `Checksum: ${state.backupChecksum}`, 'info');
        log(3, `Factures: ${state.backup.metadata.itemCounts.invoices}`, 'info');
        log(3, `Taille: ${(state.backup.metadata.compressedSize / 1024).toFixed(2)} KB`, 'info');
        markCheckItem(3);
      } catch (error) {
        log(3, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step4() {
      if (!state.backupChecksum) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 3');
        return;
      }
      
      showOutput(4);
      log(4, 'Validation du checksum SHA-256...', 'info');
      
      try {
        const isValidSHA256 = /^[a-f0-9]{64}$/i.test(state.backupChecksum);
        const checksumMatches = state.backupChecksum === state.backup.metadata.checksumSHA256;
        
        log(4, `Format valide (64 hex): ${isValidSHA256 ? '‚úÖ' : '‚ùå'}`, isValidSHA256 ? 'success' : 'error');
        log(4, `Correspond aux m√©tadonn√©es: ${checksumMatches ? '‚úÖ' : '‚ùå'}`, checksumMatches ? 'success' : 'error');
        
        if (isValidSHA256 && checksumMatches) {
          markCheckItem(4);
        } else {
          log(4, 'Checksum invalide!', 'error');
        }
      } catch (error) {
        log(4, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step5() {
      if (!state.backup) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 3');
        return;
      }
      
      showOutput(5);
      log(5, 'Export du backup en fichier...', 'info');
      
      try {
        const blob = await window.improvedBackupService.exportBackupFile();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        log(5, `Fichier t√©l√©charg√©: ${link.download} ‚úÖ`, 'success');
        log(5, `Taille: ${(blob.size / 1024).toFixed(2)} KB`, 'info');
        markCheckItem(5);
      } catch (error) {
        log(5, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step6() {
      if (!state.testInvoices.length) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 2');
        return;
      }
      
      showOutput(6);
      log(6, 'Simulation de corruption...', 'info');
      
      try {
        const invoice = await state.services.db.invoices.get('test-inv-001');
        log(6, `Avant: Total = ${invoice.total}‚Ç¨`, 'info');
        
        const corrupted = { ...invoice, total: 5000.00 };
        await state.services.db.invoices.update('test-inv-001', corrupted);
        
        const corrupted_check = await state.services.db.invoices.get('test-inv-001');
        log(6, `Apr√®s: Total = ${corrupted_check.total}‚Ç¨`, 'success');
        log(6, `Corruption cr√©√©e: 1500‚Ç¨ ‚Üí 5000‚Ç¨ ‚úÖ`, 'success');
        markCheckItem(6);
      } catch (error) {
        log(6, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step7() {
      showOutput(7);
      log(7, 'Cr√©ation du backup avec corruption...', 'info');
      
      try {
        state.corruptedBackup = await window.improvedBackupService.createBackup();
        
        log(7, `Backup corrompu cr√©√© ‚úÖ`, 'success');
        log(7, `Checksum: ${state.corruptedBackup.metadata.checksumSHA256}`, 'info');
        log(7, `Comparaison:`, 'info');
        log(7, `  Original:  ${state.backupChecksum}`, 'info');
        log(7, `  Corrompu:  ${state.corruptedBackup.metadata.checksumSHA256}`, 'info');
        log(7, `Les checksums sont diff√©rents (comme pr√©vu) ‚úÖ`, 'success');
        markCheckItem(7);
      } catch (error) {
        log(7, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step8() {
      if (!state.backup) {
        alert('Veuillez d\'abord compl√©ter l\'√©tape 3');
        return;
      }
      
      showOutput(8);
      log(8, 'Restauration depuis le backup original...', 'info');
      
      try {
        const result = await window.improvedBackupService.restoreBackup(
          state.backup.data,
          state.backup.metadata
        );
        
        log(8, `Restauration compl√©t√©e ‚úÖ`, 'success');
        log(8, `Success: ${result.success}`, 'info');
        log(8, `Factures restaur√©es: ${result.itemCounts.invoices}`, 'info');
        markCheckItem(8);
      } catch (error) {
        log(8, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step9() {
      showOutput(9);
      log(9, 'Validation de l\'int√©grit√©...', 'info');
      
      try {
        const restored = await state.services.db.invoices.get('test-inv-001');
        log(9, `Total restaur√©: ${restored.total}‚Ç¨`, 'info');
        
        if (restored.total === 1500.00) {
          log(9, `SUCC√àS: Corruption fix√©e (5000‚Ç¨ ‚Üí 1500‚Ç¨) ‚úÖ`, 'success');
          markCheckItem(9);
        } else {
          log(9, `Valeur inattendue: ${restored.total}‚Ç¨`, 'error');
        }
      } catch (error) {
        log(9, `Erreur: ${error.message}`, 'error');
      }
    }

    async function step10() {
      showOutput(10);
      log(10, 'V√©rification des audit logs...', 'info');
      
      try {
        const auditLogs = await state.services.db.auditLogs.toArray();
        log(10, `Total logs: ${auditLogs.length}`, 'info');
        
        const backupLogs = auditLogs.filter(log => 
          log.action === 'BACKUP' || log.action === 'RESTORE'
        );
        log(10, `Logs backup/restore: ${backupLogs.length}`, 'info');
        log(10, `Audit tracking op√©rationnel ‚úÖ`, 'success');
        markCheckItem(10);
      } catch (error) {
        log(10, `Erreur: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
